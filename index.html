<html>
<head>
  <title class='theme-title-tag'>Oops!</title>
  <meta charset='UTF-8' />
  <meta name='viewport' value='width=device-width, initial-scale=1, shrink-to-fit=no' />
  <link rel='stylesheet' href='css/bulma.css' />
  <link rel='stylesheet' href='css/style.css' />
  <style>
    tr > td.info-td {
      text-align: right;
    }
    
    button.home-btn {
      margin-left: 0.4rem;
    }

    .player-subtitle-block {
      text-align: center;
    }

    .bg {
      background-size: cover;
      background-repeat: no-repeat;
      width: 100%;
      height: 100%;
      left: 0;
      top: 0;
      position: fixed;
      z-index: -999;
      filter: blur(20px);
      opacity: 0.3;
    }
    
    #audio-player {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body id='theme-body'>
  <div class='bg'></div> <!-- èƒŒæ™¯åœ– -->
  <!-- æ’å…¥å‰ç¨‹å¼ç¢¼ -->
  <div class='columns'>
    <div class='column is-5'>
      <h2 class='title theme-title'>
        è«‹å•Ÿç”¨ JavaScriptï¼
      </h2>
      <h4 class='subtitle theme-subtitle'>
        ä¸é–‹ JavaScript çš„è©±å¯æ˜¯ä»€éº¼éƒ½ç”¨ä¸äº†çš„å‘¢ï¼
      </h4>
      <p class='theme-desc'>
        <figure>
          <figcaption>â–¶ï¸ <span class='playing'>ã€æœªé¸æ“‡ã€‘</span></figcaption>
          <audio controls src='' id='audio-player'>
            <track default id='audio-player-track' src=''></track>
          </audio>
          <figcaption class='player-subtitle-block'>
            <span class='player-subtitle'>æ²’æœ‰æ­Œè©ï¼</span>
          </figcaption>
        </figure>
      </p>
    </div>
    <div class='column is-7'>
      <div class='container'>
        <h4 class='title is-4'><a id='serv-info'></a>éŸ³æ¨‚æ¸…å–®</h4>
        <table class='table is-hoverable is-fullwidth' id='music-list'>
        </table>
      </div>
    </div>
  </div>
  <p>
    ç‰ˆé¢ <code><a href='https://github.com/pan93412/bulma-nginx-fancyindex'>bulma-nginx-fancyindex</a></code>
    ç”± <a href='https://github.com/pan93412'>pan93412</a> æŒªç”¨è‡³æ­¤é é¢ã€‚
    <a href='https://github.com/pan93412/today-music'><b>GitHub</b></a>
  </p>
</body>
<script src='today.js'></script>
<script>
/* Utilies */
/**
 * å°‡æ‰€æœ‰å…ƒç´ çš„ innerHTML è¨­ç‚ºæŒ‡å®šå€¼ã€‚
 *
 * @param {HTMLElement} elem å…ƒç´ 
 * @param {string} to è¨­æˆï¼Ÿ
 */
function setAllElementInnerHTML(elem, to) {
  for (let i of elem) i.innerHTML = to
}

/* éŸ³æ¨‚åˆ—è¡¨ */
const musicList = document.getElementById('music-list')
const elemId = []

function select(toSelect) {
  if (currentSelected) currentSelected.classList.remove('is-selected')
  currentSelected = toSelect
  toSelect.classList.add('is-selected')
}

/**
 * å°‡æ’­æ”¾å™¨åˆ‡æ›åˆ°ï¼Ÿ
 *
 * @param {string} musicID éŸ³æ¨‚ç·¨è™Ÿ
 */
function switchTo(musicID) {
  const elemID = 'm-' + musicID // é è¨­å…ƒä»¶ ID å°±æ˜¯ `#m-[éŸ³æ¨‚ç·¨è™Ÿ]`
  player.src = db.list[musicID].audioFile // è¨­å®šæ’­æ”¾å™¨ source
  setAllElementInnerHTML(currentPlaying, db.list[musicID].displayName) // è¨­å®šæ’­æ”¾å™¨æ¨™é¡Œ
  bg.style.backgroundImage = `url('${db.list[musicID].albumImage || ''}')` // å°‡èƒŒæ™¯åœ–è¨­æˆå°ˆè¼¯åœ–

  if (db.list[musicID].subtitle) { // å¦‚æœæœ‰å­—å¹•çš„è©±â€¦â€¦
    currentTrack.src = db.list[musicID].subtitle
    player.textTracks[0].addEventListener('cuechange', subtListener)
  } else {
    currentTrack.src = ''
    player.textTracks[0].removeEventListener('cuechange', subtListener)
    noSubt()
  }

  select(document.getElementById(elemID)) // æ¨™ç¤ºæ’­æ”¾é …ç›®
}

/* éŸ³æ¨‚æ’­æ”¾å™¨æ•´é«” */
const player = document.getElementById('audio-player')
const currentTrack = document.getElementById('audio-player-track')
const currentPlaying = document.getElementsByClassName('playing')

/* å­—å¹•æª¢è¦–å™¨ */
const subtitleViewer = document.getElementsByClassName('player-subtitle')
const str_noSelected = 'æ²’æœ‰æ­Œè©ï¼' // è«‹ç¢ºä¿èˆ‡ä¸Šæ–¹ HTML ä¸€è‡´ã€‚
const subtListener = e => {
  for (let i of subtitleViewer) {
    let subt = e.target.activeCues.length > 0 ? 
               e.target.activeCues[0].text :
              '<i>[é–“å¥]</i>'

    lastSubtitle = i.dataset.subt || '> é–‹å§‹ï¼<'
    i.dataset.subt = subt
    i.innerHTML = `<span style='opacity: 50%'>${lastSubtitle}</span><br>ğŸ¤ ${i.dataset.subt}`
  }
}
var currentSelected = null
var lastSubtitle = '' // ç›®å‰çš„å­—å¹•
function noSubt() { // ç•¶æ²’å­—å¹•æ™‚
  for (let i of subtitleViewer) {
    i.innerHTML = str_noSelected
  }
}

/* èƒŒæ™¯åœ– */
const bg = document.getElementsByClassName('bg')[0]

/* æ¨™é¡Œ / å‰¯æ¨™é¡Œ */
const pageTitleTag = document.getElementsByClassName('theme-title-tag')
const pageTitle = document.getElementsByClassName('theme-title')
const pageSubtitle = document.getElementsByClassName('theme-subtitle')

/* Main */
for (let i in db.list) { // æ–°å¢ today.js å…§çš„éŸ³æ¨‚è‡³éŸ³æ¨‚åˆ—è¡¨
  elemId.push('m-' + i)
  musicList.innerHTML += `
<tr id='m-${i}'>
  <td>${db.list[i].displayName}</td>
  <td class='info-td'>
    <a href='#m-${i}-listen'>åˆ†äº«</a>
    <a id='m-${i}-listen' href='javascript:void(0)' data-id='${i}'>æ”¶è½</a>
  </td>
</tr>`
}

for (let i of elemId) { // å°éŸ³æ¨‚åˆ—è¡¨çš„æ¯å€‹æ±è¥¿éƒ½åŠ ä¸Šäº‹ä»¶
  document.getElementById(i + '-listen').addEventListener('click', e => {
    switchTo(e.target.dataset.id)
    player.play()
  })
  document.getElementById(i).addEventListener('click', e => {
    select(document.getElementById(e.currentTarget.id))
  })
}

switchTo(db.current) // é è¨­æ’­æ”¾é …ç›®å°±æ˜¯ db.current å–”
setAllElementInnerHTML(pageTitleTag, titleTag) // è¨­å®š <title>
setAllElementInnerHTML(pageTitle, title) // è¨­å®šæ¨™é¡Œ
setAllElementInnerHTML(pageSubtitle, subtitle) // è¨­å®šå‰¯æ¨™é¡Œ
</script>
</html>
